<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Room</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>회원가입</h2>
<form id="registerForm">
    이메일: <input type="email" id="registerEmail"><br>
    비밀번호: <input type="password" id="registerPassword"><br>
    닉네임: <input type="text" id="registerNickname"><br>
    <button type="submit">회원가입</button>
</form>

<h2>로그인</h2>
<form id="loginForm">
    이메일: <input type="text" id="email"><br>
    비밀번호: <input type="password" id="password"><br>
    <button type="submit">로그인</button>
</form>

<h2>게임방</h2>
<button id="createRoom" disabled>게임방 생성</button>
게임방 ID: <input type="text" id="roomId" placeholder="참여할 게임방 ID 입력"><br>
게임방 이름: <input type="text" id="roomName" placeholder="생성할 게임방 이름 입력"><br>
<button id="joinRoom" disabled>게임방 참여</button>
<button id="leaveRoom" disabled>게임방 나가기</button>

<script>
    const apiUrl = 'http://localhost:8080';
    let stompClient = null;

    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const nickname = document.getElementById('registerNickname').value;

        axios.post(`${apiUrl}/user/signup`, { email, password, nickname })
            .then(response => {
                alert('회원가입이 완료되었습니다. 로그인해 주세요.');
            })
            .catch(error => {
                console.error('회원가입 실패', error);
                alert('회원가입 실패');
            });
    });

    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        axios.post(`${apiUrl}/user/login`, { email, password })
            .then(response => {
                localStorage.setItem('authToken', response.headers['authorization']);
                localStorage.setItem('email', email); // 로그인한 사용자의 이메일을 로컬 스토리지에 저장
                document.getElementById('createRoom').disabled = false;
                document.getElementById('joinRoom').disabled = false;
                alert('로그인 성공');
                connectWebSocket();
            })
            .catch(error => alert('로그인 실패'));
    });

    const connectWebSocket = () => {
        const socket = new SockJS(`${apiUrl}/ws`);
        stompClient = Stomp.over(socket);
        const authToken = localStorage.getItem('authToken');
        stompClient.connect({'Authorization': authToken}, function(frame) {
            console.log('Connected: ' + frame);
        }, function(error) {
            console.log('WebSocket connection error: ' + error);
        });
    };

    document.getElementById('createRoom').addEventListener('click', function() {
        const authToken = localStorage.getItem('authToken');
        const roomName = document.getElementById('roomName').value;
        axios.post(`${apiUrl}/gameRoom/create`, { name: roomName }, {
            headers: { 'Authorization': authToken }
        })
            .then(response => {
                const roomId = response.data.data.roomId;
                alert('게임방이 생성되었습니다. 방 ID: ' + roomId);
                document.getElementById('roomId').value = roomId;
                document.getElementById('leaveRoom').disabled = false;
                window.location.href = `gameRoomDetails.html?roomId=${roomId}`;
            })
            .catch(error => alert('게임방 생성 실패'));
    });


    document.getElementById('joinRoom').addEventListener('click', function() {
        const roomId = document.getElementById('roomId').value;
        if(stompClient && roomId) {
            stompClient.send(`/app/${roomId}/join`, {}, "");
            alert(`Attempting to join game room ${roomId}`);
            window.location.href = `gameRoomDetails.html?roomId=${roomId}`;
        }
    });

</script>
</body>
</html>